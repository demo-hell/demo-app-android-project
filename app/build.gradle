plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'kotlin-android-extensions'
    id 'kotlin-kapt'

    id 'com.google.firebase.appdistribution'
    id 'com.google.firebase.crashlytics'
    id 'com.google.gms.google-services'
    id 'androidx.navigation.safeargs'
    id 'me.moallemi.advanced-build-version'
    id 'dexguard'
    id 'com.datadoghq.dd-sdk-android-gradle-plugin'
}

repositories {
    mavenCentral()
    google()
    jcenter()

    def props = resolveKeyProps()
    maven {
        authentication {
            basic(BasicAuthentication)
        }
        credentials {
            username props.getProperty("allow_me_credentials_username")
            password props.getProperty("allow_me_credentials_password")
        }
        url "https://sdk.allowmecloud.com/android/platao/"
    }
    maven { url 'https://jitpack.io' }
    maven { url "https://salesforce-marketingcloud.github.io/MarketingCloudSDK-Android/repository" }
    maven {        // For the DexGuard Gradle plugin jar.
        credentials {
            username = "maven"
            password = "${dexguardMavenToken}"
        }
        url = uri("https://maven.guardsquare.com")
        // Only search for artifacts with groupId "com.guardsquare.*",
        // supported since gradle 5.1.
        content {
            includeGroupByRegex("com\\.guardsquare.*")
        }
        authentication {
            basic(BasicAuthentication)
        }

    }
    maven {
        url 'https://identify-maven.stoneage.com.br'
    }

    maven {
        url "https://maven-sdk.unico.run/sdk-mobile"
    }
}

advancedVersioning {
    codeOptions {
        versionCodeType 'GIT_COMMIT_COUNT'
    }
}


def appVersionName = "8.9.1"
def releaseAppVersionCode = 355
def appVersionCode = advancedVersioning.versionCode

def resolveKeyProps() {
    def properties = new Properties()
    if (rootProject.file("local.properties").exists()) {
        properties.load(rootProject.file("local.properties").newDataInputStream())
    } else {
        properties.setProperty("release_cielo_store_file", "${System.getenv('SIGN_KEYSTORE_FILE')}")
        properties.setProperty("release_cielo_store_key_password", "${System.getenv('STORE_KEY_PASSWORD')}")
        properties.setProperty("release_cielo_key_alias", "${System.getenv('KEY_ALIAS')}")
        properties.setProperty("release_cielo_key_password", "${System.getenv('KEY_PASSWORD')}")
        properties.setProperty("allow_me_credentials_username", "${System.getenv('ALLOWME_USERNAME')}")
        properties.setProperty("allow_me_credentials_password", "${System.getenv('ALLOWME_PASSWORD')}")
        properties.setProperty("cielo_guardsquare", "${System.getenv('$CIELO_GUARDSQUARE')}")
        properties.setProperty("path_apk", "${System.getenv('PATH_APK')}")
        properties.setProperty("firebase_keystore_file", "${System.getenv('FIREBASE_KEYSTORE_FILE')}")
        properties.setProperty("datadog_token", "${System.getenv('$DATADOG_TOKEN')}")
        properties.setProperty("datadog_application_id", "${System.getenv('$DATADOG_APPLICATION_ID')}")
        properties.setProperty("mobile_push_app_id", "${System.getenv('$MOBILE_PUSH_APP_ID')}")
        properties.setProperty("mobile_push_sender_id", "${System.getenv('$MOBILE_PUSH_SENDER_ID')}")
        properties.setProperty("mobile_push_access_token", "${System.getenv('MOBILE_PUSH_ACCESS_TOKEN')}")
        properties.setProperty("mobile_push_cloud_server_url", "${System.getenv('MOBILE_PUSH_CLOUD_SERVER_URL')}")
        properties.setProperty("mobile_push_mid", "${System.getenv('MOBILE_PUSH_MID')}")
    }
    return properties
}

def props = resolveKeyProps()
def gradleProps = new Properties()
if (rootProject.file("gradle.properties").exists()) {
    gradleProps.load(rootProject.file("gradle.properties").newDataInputStream())
}

def API_VERSION = 1
android {
    compileSdkVersion 33
    buildToolsVersion '33.0.2'

    testOptions {
        unitTests.returnDefaultValues = true
    }
    defaultConfig {
        applicationId "br.com.mobicare.cielo"
        minSdkVersion 23
        targetSdkVersion 33
        vectorDrawables.useSupportLibrary = true
        testInstrumentationRunner "br.com.mobicare.cielo.CieloTestRunner"
        buildConfigField "String", "API_VERSION", "\"" + API_VERSION + "\""
        buildConfigField "String", "SERVER_MAPS_URL", "\"http://maps.google.com/maps/api/\""
        buildConfigField "String", "GOOGLE_MAPS_SERVER_URL", "\"http://maps.google.com/\""
        buildConfigField "String", "GOOGLE_MAPS_KEY", "\"AIzaSyA7ECBk5RrANoKAwZdUBcdbYOtv2zlf2DQ\""
        buildConfigField "String", "DATADOG_TOKEN", "\"${gradleProps.getProperty("datadog_token")}\""
        buildConfigField "String", "DATADOG_APPLICATION_ID", "\"${gradleProps.getProperty("datadog_application_id")}\""
        buildConfigField "String", "MOBILE_PUSH_APP_ID", "\"${gradleProps.getProperty("mobile_push_app_id")}\""
        buildConfigField "String", "MOBILE_PUSH_SENDER_ID", "\"${gradleProps.getProperty("mobile_push_sender_id")}\""
        buildConfigField "String", "MOBILE_PUSH_ACCESS_TOKEN", "\"${gradleProps.getProperty("mobile_push_access_token")}\""
        buildConfigField "String", "MOBILE_PUSH_CLOUD_SERVER_URL", "\"${gradleProps.getProperty("mobile_push_cloud_server_url")}\""
        buildConfigField "String", "MOBILE_PUSH_MID", "\"${gradleProps.getProperty("mobile_push_mid")}\""
        buildConfigField "String", "APP_NAME", '"Cielo"'
        buildConfigField "int", "OTP_BIT_MASK_F", '0xf'
        buildConfigField "int", "OTP_BIT_MASK_7", '0x7f'
        buildConfigField "int", "OTP_SHIFT_24_MASK", '0x18'
        buildConfigField "int", "OTP_FULL_BYTE_MASK", '0xff'
        buildConfigField "int", "OTP_SUBSECTION_MASK", '0x10'
        buildConfigField "int", "OTP_BIT_3_MASK", '0x08'

        renderscriptTargetApi 28
        renderscriptSupportModeEnabled true
    }

    aaptOptions {
        additionalParameters "--no-version-vectors"
    }

    kotlinOptions {
        jvmTarget = JavaVersion.VERSION_1_8.toString()
        freeCompilerArgs += [
                "-P",
                "plugin:androidx.compose.compiler.plugins.kotlin:suppressKotlinVersionCompatibilityCheck=true"
        ]
    }

    buildFeatures {
        compose true
        viewBinding true
    }

    composeOptions {
        kotlinCompilerExtensionVersion compose_version
        kotlinCompilerVersion kotlin_version
    }

    signingConfigs {
        release {
            storeFile file(props.getProperty("release_cielo_store_file"))
            storePassword props.getProperty("release_cielo_store_key_password")
            keyAlias props.getProperty("release_cielo_key_alias")
            keyPassword props.getProperty("release_cielo_key_password")
        }
    }

    buildTypes {
        release {
            debuggable false
            minifyEnabled false
            shrinkResources false
            crunchPngs false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            ext.betaDistributionReleaseNotesFilePath = "release_notes_prd.txt"
            proguardFiles 'dexguard-project.txt'
            ext.betaDistributionEmailsFilePath = "distribution_fabric_emails_prod.txt"
            firebaseAppDistribution {
                appId = "1:348069280265:android:b1c1a092adca9543"
                artifactPath = props.getProperty("path_apk")
                artifactType = "APK"
                releaseNotes = "PipelineID: ${System.getenv('CI_PIPELINE_ID')}\nBranch: ${System.getenv('CI_COMMIT_BRANCH')}\nCommitHash: ${System.getenv('COMMIT_HASH')}\n\nChanges:\n${System.getenv('COMMIT_MESSAGE')}"
                groups = "qa, id-onboarding, pix"
                serviceCredentialsFile = props.getProperty("firebase_keystore_file")
            }

            buildConfigField("String", "URL_CERTIFICATE_PRD", "\"https://api.cielo.com.br\"")
            buildConfigField("String", "SHA_CERTIFICATE_PRD_RSA_AKAMAI", "\"sha256/39a76ea2f3d7ae85d851462a8a422047f4dbccc0a52a6569d57b7865b920d638=\"")
        }

        homolog {
            minifyEnabled false
            shrinkResources false
            debuggable true
            minifyEnabled false
            ext.enableCrashlytics = false
            testCoverageEnabled false
            crunchPngs false
            ext.betaDistributionReleaseNotesFilePath = "release_notes.txt"
            ext.betaDistributionEmailsFilePath = "distribution_fabric_emails.txt"
            firebaseAppDistribution {
                appId = "1:348069280265:android:b1c1a092adca9543"
                artifactPath = props.getProperty("path_apk")
                artifactType = "APK"
                releaseNotes = "PipelineID: ${System.getenv('CI_PIPELINE_ID')}\nBranch: ${System.getenv('CI_COMMIT_BRANCH')}\nCommitHash: ${System.getenv('COMMIT_HASH')}\n\nChanges:\n${System.getenv('COMMIT_MESSAGE')}"
                groups = "qa, id-onboarding, pix"
                serviceCredentialsFile = props.getProperty("firebase_keystore_file")

                buildConfigField("String", "URL_CERTIFICATE_PRD", "\"https://api.cielo.com.br\"")
                buildConfigField("String", "SHA_CERTIFICATE_PRD_RSA_AKAMAI", "\"\"")
            }
        }
    }

    flavorDimensions "default"
    productFlavors {
        store {
            versionCode releaseAppVersionCode
            versionName "$appVersionName"
            signingConfig signingConfigs.release
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            proguardFiles 'dexguard-project.txt'

            buildConfigField "String", "SERVER_URL", "\"https://app-core.cielo.com.br\""
            buildConfigField "String", "HOST_API", "\"https://api.cielo.com.br/\""

            buildConfigField "String", "CLIENT_ID", "\"ZitZlNvXgAzb\""
            buildConfigField "String", "CLIENT_SECRET", "\"aWnPwJbCtDn0\""

            buildConfigField "String", "RESOURCES_URL", "\"https://digitalti.hdevelo.com.br/\""
            buildConfigField "String", "SERVER_URL_CHAT", "\"https://apollo.cielo.com.br/webview/\""
            buildConfigField "String", "URL_RECOVER_PASSWORD", "\"http://cielo-app-password-hml.s3-website-sa-east-1.amazonaws.com/\""

            buildConfigField "String", "SERVER_CLOUD_CIELO", "\"https://apollodev.hdevelo.com.br/\""
            buildConfigField "String", "URL_FAROL", "\"https://minhaconta2.cielo.com.br/site-farol/m\""
            buildConfigField "String", "URL_FAROL_CONCILIADOR", "\"https://minhaconta2.cielo.com.br/site-farol/m?origin=conciliador\""
            buildConfigField "int", "PLAN_ID_FAROL_CONCILIADOR", '523'
            buildConfigField "String", "AUTO_REGISTER_URL", "\"https://minhaconta2.cielo.com.br/auto-cadastro-prd/\""

            buildConfigField "String", "CONDITION_TERMS_URL", "\"https://minhaconta2.cielo.com.br/multicanalidade/assets/termosecondicoessitecielo.pdf\""
            buildConfigField "String", "BANNER_TERMS_URL", "\"https://minhaconta2.cielo.com.br/assets/contratos/{bannerName}.pdf\""

            buildConfigField "String", "CARD_BRAND_IMAGE_URL", "\"https://minhaconta2.cielo.com.br/merchant/solutions/static/assets/img/brands/brand_{0}.png\""
            buildConfigField "String", "CARD_BRAND_IMAGE_URL_CONCILIADOR", "\"https://minhaconta2.cielo.com.br/assets/app/brand/png/brand_{0}.png\""

            buildConfigField "String", "CARD_ACQUIRER_IMAGE_URL_CONCILIADOR", "\"https://minhaconta2.cielo.com.br/assets/app/acquirer/png/acquirer_{0}.png\""
            buildConfigField "String", "LOAD_BRAND_IMAGE_GENERIC", "\"https://minhaconta2.cielo.com.br/flui-flags/banks/png/bank_{0}.png\""

            buildConfigField "String", "TECHNICAL_SUPPORT_URL", "\"https://minhaconta2.cielo.com.br/suporte-tecnico-prd/\""

            buildConfigField "String", "URL_CHAT_AVALIACAO", "\"https://minhaconta2.cielo.com.br/pesquisa-satisfacao-prd/\""

            buildConfigField "String", "CHAT_URL", "\"https://minhaconta2.cielo.com.br/novo-chat-prd/\""
            buildConfigField "String", "APPSFLYER_KEY", "\"jKxdg8hAcpKSarJCBExcUU\""
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            proguardFiles 'dexguard-project.txt'

            buildConfigField "String", "ORG_ID", '"k8vif92e"'

            buildConfigField "String", "TAP_KEY", "\"9KnDciL5@pkMqDs&mdCiPewQcsAzK@j@idCwuTdCpOU%jS\""
            buildConfigField "Boolean", "TAP_TEST_MODE", "false"
            buildConfigField "com.symbiotic.taponphone.Enums.Environment", "TAP_ENVIROMENT", "com.symbiotic.taponphone.Enums.Environment.Production"

            buildConfigField "String", "CREDECIAMENTO_URL", "\"https://onboarding-express.cielo.com.br/app\""
            buildConfigField "String", "URL_OPF_CALLBACK", "\"https://api-open-finance.cielo.com.br/open-banking/redirect/v1/bank-callback\""
            buildConfigField "String", "RECEBIVEIS_URL", "\"https://app-extratodigital.cielo.com.br/recebiveis\""
            buildConfigField "String", "SALES_URL", "\"https://app-extratodigital.cielo.com.br/vendas\""

            buildConfigField "String", "UNICO_HOST_INFO", "\"Up4XTo9Enmc9krxVWOW2Kvjc21ls5s5tepdTxrcAtVQ=\""
            buildConfigField "String", "UNICO_HOST_KEY", "\"kq8jxBAtbyDJG/2HtE7MwYqmPoiloJznWmZ+XuTBksPTps5N6LaYiRHm/NcnJgEu\""
            buildConfigField "String", "UNICO_MOBILE_SDK_APP_ID", "\"1:321342:android\""
            buildConfigField "String", "UNICO_PROJECT_ID", "\"cielo gestao\""
            buildConfigField "String", "UNICO_PROJECT_NUMBER", "\"2746785429746906732569\""
        }

        dev {
            versionCode appVersionCode
            versionName "$appVersionName"
            signingConfig signingConfigs.release
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            proguardFiles 'dexguard-project.txt'
            applicationIdSuffix '.homolog'

            buildConfigField "String", "SERVER_URL", "\"http://apollo-core-goserver-hml-974641995.sa-east-1.elb.amazonaws.com\""
            buildConfigField "String", "HOST_API", "\"https://apihom.cielo.com.br/\""
            buildConfigField "String", "SERVER_URL_CHAT", "\"https://apollodev.hdevelo.com.br/webview/\""
            buildConfigField "String", "CONDITION_TERMS_URL", "\"https://digitalhml.hdevelo.com.br/multicanalidade/assets/termosecondicoessitecielo.pdf\""
            buildConfigField "String", "BANNER_TERMS_URL", "\"https://digitalhml.hdevelo.com.br/assets/contratos/{bannerName}.pdf\""

            buildConfigField "String", "CLIENT_ID", "\"5o2lgoYzxp3jI9sXRBeDAujh5yWVpOsYhCYyqujubyOM0CNK0z\""
            buildConfigField "String", "CLIENT_SECRET", "\"PCyA1ckdEPgHHzo9SjJLFalvbJ5O2CQu7Lhwc0paMDsjnnboYA\""

            buildConfigField "String", "RESOURCES_URL", "\"https://digitalti.hdevelo.com.br/\""
            buildConfigField "String", "URL_RECOVER_PASSWORD", "\"http://cielo-app-password-hml.s3-website-sa-east-1.amazonaws.com/\""
            buildConfigField "String", "URL_CHAT_AVALIACAO", "\"https://digitalhml.hdevelo.com.br/pesquisa-satisfacao-prd/\""

            buildConfigField "String", "CARD_BRAND_IMAGE_URL", "\"https://minhaconta2.cielo.com.br/merchant/solutions/static/assets/img/brands/brand_{0}.png\""
            buildConfigField "String", "CARD_BRAND_IMAGE_URL_CONCILIADOR", "\"https://digitalhml.hdevelo.com.br/assets/app/brand/png/brand_{0}.png\""

            buildConfigField "String", "CARD_ACQUIRER_IMAGE_URL_CONCILIADOR", "\"https://digitalhml.hdevelo.com.br/assets/app/acquirer/png/acquirer_{0}.png\""
            buildConfigField "String", "LOAD_BRAND_IMAGE_GENERIC", "\"https://minhaconta2.cielo.com.br/flui-flags/banks/png/bank_{0}.png\""

            buildConfigField "String", "SERVER_CLOUD_CIELO", "\"https://apollodev.hdevelo.com.br/\""
            buildConfigField "String", "URL_FAROL", "\"https://digitalhml.hdevelo.com.br/site-farol/m\""
            buildConfigField "String", "URL_FAROL_CONCILIADOR", "\"https://digitalhml.hdevelo.com.br/site-farol/m?origin=conciliador\""
            buildConfigField "int", "PLAN_ID_FAROL_CONCILIADOR", '2366'
            buildConfigField "String", "AUTO_REGISTER_URL", "\"https://digitalhml.hdevelo.com.br/auto-cadastro-prd/\""
            buildConfigField "String", "CHAT_URL", "\"https://digitalhml.hdevelo.com.br/novo-chat-prd/\""

            buildConfigField "String", "TECHNICAL_SUPPORT_URL", "\"https://digitalhml.hdevelo.com.br/suporte-tecnico-prd/\""
            buildConfigField "String", "APPSFLYER_KEY", "\"QnVqWWwFhgtYhnWfyRLMvN\""
            buildConfigField "String", "ORG_ID", '"1snn5n9w"'

            buildConfigField "String", "TAP_KEY", "\"9KnDciL5@pkMqDs&mdCiPewQcsAzK@j@idCwuTdCpOU%jS\""
            buildConfigField "Boolean", "TAP_TEST_MODE", "true"
            buildConfigField "com.symbiotic.taponphone.Enums.Environment", "TAP_ENVIROMENT", "com.symbiotic.taponphone.Enums.Environment.Test"

            buildConfigField "String", "CREDECIAMENTO_URL", "\"https://onboarding-express-hml.cielo.com.br/app\""
            buildConfigField "String", "URL_OPF_CALLBACK", "\"https://api-open-finance-h.cielo.com.br/open-banking/redirect/v1/bank-callback\""
            buildConfigField "String", "RECEBIVEIS_URL", "\"https://app-extratodigital.hdevelo.com.br/recebiveis\""
            buildConfigField "String", "SALES_URL", "\"https://app-extratodigital.hdevelo.com.br/vendas\""

            buildConfigField "String", "UNICO_HOST_INFO", "\"nRMqSJJeWMZ0K4n9Dxs/Zhb5RslAxes+pmH0gJgmVtZjSWEzKMY5MLDpUMATXWo/\""
            buildConfigField "String", "UNICO_HOST_KEY", "\"6KE5tpR2UAy3cAnWaB/tz4E1lIaZhimELZhjXTtlLxp1H/SWzSFd55BuGctsNoOP\""
            buildConfigField "String", "UNICO_MOBILE_SDK_APP_ID", "\"1:638873:android\""
            buildConfigField "String", "UNICO_PROJECT_ID", "\"cielo gestao\""
            buildConfigField "String", "UNICO_PROJECT_NUMBER", "\"65635378430815246989\""
        }
    }

    sourceSets {
        homolog {
            java.srcDirs = ['src/api/java']
            res.srcDirs = ['src/api/res']
        }

        release {
            java.srcDirs = ['src/api/java']
            res.srcDirs = ['src/api/res']
        }
    }

    dataBinding {
        enabled = true
    }

    sourceSets {
        main {
            main {
                file('src/main/res')
                        .listFiles()
                        .each { res.srcDirs += it.path }
            }
        }
    }

    lintOptions {
        abortOnError false
        disable 'RestrictedApi'
    }

    testBuildType "homolog"

    testOptions {
        unitTests.includeAndroidResources true
        unitTests.all {
            jvmArgs(
                    "--add-opens", "java.base/java.time=ALL-UNNAMED",
                    "--add-opens", "java.base/java.lang.reflect=ALL-UNNAMED"
            )
        }
    }

    androidExtensions {
        experimental = true
    }

    bundle {
        density {
            enableSplit true
        }
        abi {
            enableSplit true
        }
        language {
            enableSplit false
        }
    }

    splits {
        abi {
            enable project.hasProperty("splitEnabled")
            reset()
            include "x86", "armeabi-v7a", "arm64-v8a", "x86_64", 'armeabi', 'mips', 'mips64'
            universalApk false
        }
    }

    android {
        sourceSets {
            main {
                jniLibs.srcDirs = ['libs']
            }
        }
    }
}

dexguard {
    jvmArgs "-Xmx3g"
    version = "9.3.26"
    license = "$project.rootDir/tools/dexguard-license.txt"
    configurations {
        release {
            defaultConfiguration("dexguard-release.pro")
            configuration("dexguard-rules.pro")
            uploadCrashlyticsMappingFile = true
        }
    }
}

task notifyDeliveryHml {
    doLast {
        exec {
            commandLine 'curl', '-f', '-H', 'Content-Tpe: application/json', '-X', 'POST', '-d', '{ "@context": "https://schema.org/extensions", "@type": "MessageCard", "themeColor": "0072C6", "summary": "Existe uma nova versão Cielo Gestão!", "sections": [{ "activityTitle": "Existe uma nova versão Cielo Gestão!", "activitySubtitle": "Projeto: Cielo Gestão", "activityImage": "' + System.getenv('PLATFORM_IMAGE_URL') + '", "facts": [ { "name": "Plataforma", "value": "' + System.getenv('PLATFORM') + '" }, { "name": "Versão", "value": "' + appVersionName + ' ( ' + appVersionCode + ' )' + '" }, { "name": "PipelineID", "value": "' + System.getenv('CI_PIPELINE_ID') + '" }, { "name": "Branch", "value": "' + System.getenv('CI_COMMIT_BRANCH') + '" }, { "name": "Commit Hash", "value": "' + System.getenv('COMMIT_HASH') + '" }, { "name": "Alterações", "value": "' + System.getenv('COMMIT_MESSAGE') + '" }], "markdown": true }], "potentialAction": [ { "@type": "OpenUri", "name": "Abrir Firebase App Distribution ", "targets": [ { "os": "default", "uri": "' + System.getenv('FIREBASE_APP_DISTRIBUTION_URL') + '"} ] } ] }', System.getenv('NOTIFICATION_WEBHOOK_URL')
        }
    }
}

configurations.all {
    resolutionStrategy {
        eachDependency { details ->
            if ('org.jacoco' == details.requested.group) {
                details.useVersion "0.8.7"
            }
        }
    }

    exclude group: 'com.google.android.gms', module: 'play-services-ads'
    exclude group: 'com.google.android.gms', module: 'play-services-ads-lite'
}

apply from: "$project.rootDir/tools/dependencies.gradle"
apply from: "$project.rootDir/tools/script-java-code-coverage.gradle"
apply from: "$project.rootDir/tools/script-cielo-configuration.gradle"